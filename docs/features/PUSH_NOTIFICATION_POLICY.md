# í‘¸ì‹œ ì•Œë¦¼ ì •ì±… v3.0

> ìµœì¢… ì—…ë°ì´íŠ¸: 2025-11-30
> ëª©ì : í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡ ê¸°ì¤€ ë° ë©”ì‹œì§€ ê´€ë¦¬

## ê°œìš”

MandaAct ì•±ì˜ ëª¨ë“  í‘¸ì‹œ ì•Œë¦¼ ì •ì±…ì„ ì •ì˜í•©ë‹ˆë‹¤. í‘¸ì‹œ ì•Œë¦¼ì˜ ëª©ì ì€ **ìœ ì €ê°€ ì•±ìœ¼ë¡œ ë“¤ì–´ì˜¤ê²Œ í•˜ê¸° ìœ„í•¨**ì…ë‹ˆë‹¤.

**í•µì‹¬ ë³€ê²½ (v3.0)**: ëª¨ë“  ì•Œë¦¼ì´ **ì„œë²„ í‘¸ì‹œ(pg_cron + Expo Push API)** ë°©ì‹ìœ¼ë¡œ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œì»¬ ì•Œë¦¼ì€ ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ì°¸ê³ **: ì•± ë‚´ì—ì„œ í† ìŠ¤íŠ¸ë¡œ í‘œì‹œë˜ëŠ” ì•Œë¦¼(ë ˆë²¨ì—…, ë±ƒì§€ íšë“ ë“±)ì€ í‘¸ì‹œ ì•Œë¦¼ìœ¼ë¡œ êµ¬í˜„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ì•Œë¦¼ ì¹´í…Œê³ ë¦¬

| ì¹´í…Œê³ ë¦¬ | ì„¤ëª… | ìœ ì € ì œì–´ |
|---------|------|----------|
| **ì‹¤ì²œ ì•Œë¦¼** | ì‹¤ì²œ ê´€ë ¨ ë¦¬ë§ˆì¸ë” | ì‹œê°„ëŒ€ ì„¤ì • ê°€ëŠ¥ |
| **ë§ì¶¤ ë©”ì‹œì§€** | ë¦¬í¬íŠ¸ ì•ˆë‚´, ë³µê·€ ìœ ë„ ë“± | ON/OFFë§Œ ê°€ëŠ¥ |

---

## ì•Œë¦¼ ìœ í˜• ìš”ì•½

| ì¹´í…Œê³ ë¦¬ | ì•Œë¦¼ ID | ë°œì†¡ ì‹œì  | ë°œì†¡ ì¡°ê±´ | ìƒíƒœ |
|---------|---------|----------|----------|------|
| ì‹¤ì²œ ì•Œë¦¼ | `daily_reminder` | ìœ ì € ì„¤ì • ì‹œê°„ | ì•Œë¦¼ ON | âœ… êµ¬í˜„ì™„ë£Œ |
| ë§ì¶¤ ë©”ì‹œì§€ | `weekly_report` | ì›” 12:00~ (ìƒì„± ì¦‰ì‹œ) | ì „ì£¼ ì‹¤ì²œ â‰¥1íšŒ | âœ… êµ¬í˜„ì™„ë£Œ |
| ë§ì¶¤ ë©”ì‹œì§€ | `streak_warning` | ë§¤ì¼ 21:00 | ì˜¤ëŠ˜ 0íšŒ + ìŠ¤íŠ¸ë¦­ â‰¥3ì¼ | âœ… êµ¬í˜„ì™„ë£Œ |
| ë§ì¶¤ ë©”ì‹œì§€ | `comeback_3d` | ë§¤ì¼ 19:00 | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 3ì¼ | âœ… êµ¬í˜„ì™„ë£Œ |
| ë§ì¶¤ ë©”ì‹œì§€ | `comeback_7d` | ë§¤ì¼ 19:00 | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 7ì¼ | âœ… êµ¬í˜„ì™„ë£Œ |
| ë§ì¶¤ ë©”ì‹œì§€ | `comeback_14d` | ë§¤ì¼ 19:00 | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 14ì¼ | âœ… êµ¬í˜„ì™„ë£Œ |

---

## 1. ì‹¤ì²œ ì•Œë¦¼

### 1.1 ì¼ì¼ ë¦¬ë§ˆì¸ë” (`daily_reminder`) âœ… ì„œë²„ í‘¸ì‹œ ì „í™˜ ì™„ë£Œ

**ê°œì¸í™”ëœ ë©”ì‹œì§€ë¡œ ì‹¤ì²œ í–‰ë™ ìœ ë„**

| í•­ëª© | ë‚´ìš© |
|-----|------|
| **ì•Œë¦¼ ID** | `daily_reminder` |
| **ë°œì†¡ ë°©ì‹** | ì„œë²„ í‘¸ì‹œ (pg_cron â†’ Expo Push API) |
| **ë°œì†¡ ì‹œì ** | ìœ ì € ì„¤ì • ì‹œê°„ (ê¸°ë³¸ 20:00 KST) |
| **ë°œì†¡ ì¡°ê±´** | ì‹¤ì²œ ì•Œë¦¼ ON + ì²´í¬ ê°€ëŠ¥í•œ ì•¡ì…˜ â‰¥1ê°œ |
| **ì„¤ì • ì €ì¥** | `notification_settings` í…Œì´ë¸” (DB) |

#### ë©”ì‹œì§€ (ê°œì¸í™”)

| ì¡°ê±´ | ì œëª© | ë³¸ë¬¸ |
|------|------|------|
| ì˜¤ëŠ˜ ì‹¤ì²œ 0íšŒ + ìŠ¤íŠ¸ë¦­ â‰¥1 | {ë‹‰ë„¤ì„}ë‹˜, {n}ì¼ì§¸ ì‹¤ì²œ ì¤‘! ğŸ”¥ | ì˜¤ëŠ˜ë„ ì´ì–´ê°€ë©´ {n+1}ì¼ ë‹¬ì„±! |
| ì˜¤ëŠ˜ ì‹¤ì²œ 0íšŒ + ì•¡ì…˜ëª… ìˆìŒ | {ë‹‰ë„¤ì„}ë‹˜, ì•„ì§ {n}ê°œ ë‚¨ì•˜ì–´ìš”! | {action_name} ì§€ê¸ˆ ì™„ë£Œí•´ë³¼ê¹Œìš”? |
| ì˜¤ëŠ˜ ì‹¤ì²œ 0íšŒ | {ë‹‰ë„¤ì„}ë‹˜, ì˜¤ëŠ˜ì˜ ì‹¤ì²œì„ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸ’ª | {n}ê°œì˜ ì‹¤ì²œì´ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”. |
| ì˜¤ëŠ˜ ì¼ë¶€ ì™„ë£Œ | {ë‹‰ë„¤ì„}ë‹˜, ì˜¤ëŠ˜ {done}/{total} ì™„ë£Œ! ğŸ’ª | {remaining}ê°œë§Œ ë” í•˜ë©´ ëª©í‘œ ë‹¬ì„±ì´ì—ìš”. |
| ì˜¤ëŠ˜ ì „ë¶€ ì™„ë£Œ | {ë‹‰ë„¤ì„}ë‹˜, ì˜¤ëŠ˜ë„ ì™„ë²½í•´ìš”! ğŸ‰ | ë‚´ì¼ë„ ì´ ì»¨ë””ì…˜ ìœ ì§€í•´ë´ìš”. |

**ìš°ì„ ìˆœìœ„**: ìŠ¤íŠ¸ë¦­ ë©”ì‹œì§€ > ì™„ë£Œ ìƒíƒœ ë©”ì‹œì§€ > ê¸°ë³¸ ë©”ì‹œì§€

**ë‹‰ë„¤ì„ ì²˜ë¦¬**: ë‹‰ë„¤ì„ ì—†ìœ¼ë©´ ì´ë©”ì¼ ì•ë¶€ë¶„ ë˜ëŠ” "íšŒì›"ìœ¼ë¡œ ëŒ€ì²´

#### êµ¬í˜„ íŒŒì¼

- DB Migration: `supabase/migrations/20251130000007_daily_reminder_server_push.sql`
- SQL Functions:
  - `get_users_for_daily_reminder(p_hour)`: í•´ë‹¹ ì‹œê°„ ì•Œë¦¼ ëŒ€ìƒ ì¡°íšŒ
  - `process_daily_reminder_notifications(p_hour)`: ì¼ê´„ ë°œì†¡ ì²˜ë¦¬
- ëª¨ë°”ì¼ ì„¤ì •: `apps/mobile/src/hooks/useNotifications.ts`

---

## 2. ë§ì¶¤ ë©”ì‹œì§€

### 2.1 ì£¼ê°„ ë¦¬í¬íŠ¸ (`weekly_report`) âœ… êµ¬í˜„ì™„ë£Œ

| í•­ëª© | ë‚´ìš© |
|-----|------|
| **ì•Œë¦¼ ID** | `weekly_report` |
| **ë°œì†¡ ë°©ì‹** | ì„œë²„ í‘¸ì‹œ (Expo Push API) |
| **íŠ¸ë¦¬ê±°** | pg_cron â†’ Edge Function â†’ ê°œì¸ë³„ ìƒì„± ì™„ë£Œ ì‹œ ì¦‰ì‹œ ë°œì†¡ |
| **ë°œì†¡ ì‹œì ** | ì›”ìš”ì¼ 12:00 KSTë¶€í„° ìˆœì°¨ ë°œì†¡ |
| **ë°œì†¡ ì¡°ê±´** | ì „ì£¼ ì‹¤ì²œ â‰¥1íšŒ AND í‘¸ì‹œ í† í° í™œì„±í™” |

#### ë©”ì‹œì§€

| ì œëª© | ë³¸ë¬¸ |
|------|------|
| {ë‹‰ë„¤ì„}ë‹˜ì˜ ì£¼ê°„ ë¦¬í¬íŠ¸ê°€ ë„ì°©í–ˆì–´ìš”! | ì§€ë‚œ ì£¼ ì‹¤ì²œ íŒ¨í„´ì„ í™•ì¸í•´ë³´ì„¸ìš”. |

#### êµ¬í˜„ íŒŒì¼

- ìŠ¤ì¼€ì¤„ëŸ¬: `supabase/migrations/20251130000001_add_push_tokens_and_weekly_report_cron.sql`
- Edge Function: `supabase/functions/scheduled-report/index.ts`
- ë°œì†¡ í•¨ìˆ˜: `supabase/functions/send-push-notification/index.ts`

---

### 2.2 ìŠ¤íŠ¸ë¦­ ìœ„í—˜ ì•Œë¦¼ (`streak_warning`) âœ… êµ¬í˜„ì™„ë£Œ

| í•­ëª© | ë‚´ìš© |
|-----|------|
| **ì•Œë¦¼ ID** | `streak_warning` |
| **ë°œì†¡ ë°©ì‹** | ì„œë²„ í‘¸ì‹œ (Expo Push API) |
| **íŠ¸ë¦¬ê±°** | pg_cron â†’ Edge Function |
| **ë°œì†¡ ì‹œì ** | ë§¤ì¼ 21:00 KST |
| **ë°œì†¡ ì¡°ê±´** | ì˜¤ëŠ˜ ì‹¤ì²œ 0íšŒ AND ìŠ¤íŠ¸ë¦­ â‰¥3ì¼ AND ë§ì¶¤ ë©”ì‹œì§€ ON |
| **ì¤‘ë³µ ë°©ì§€** | ë™ì¼ ë‚ ì§œì— 1íšŒë§Œ ë°œì†¡ |

#### ë©”ì‹œì§€ (ìŠ¤íŠ¸ë¦­ êµ¬ê°„ë³„)

| ìŠ¤íŠ¸ë¦­ | ì œëª© | ë³¸ë¬¸ |
|--------|------|------|
| 3~6ì¼ | {ë‹‰ë„¤ì„}ë‹˜, {n}ì¼ ìŠ¤íŠ¸ë¦­ì„ ì´ì–´ê°€ì„¸ìš”! ğŸ”¥ | ìì • ì „ì— 1ê°œë§Œ ì‹¤ì²œí•˜ë©´ ìœ ì§€ë¼ìš”. |
| 7~29ì¼ | {ë‹‰ë„¤ì„}ë‹˜, {n}ì¼ ìŠ¤íŠ¸ë¦­ì´ ìœ„í—˜í•´ìš”! ğŸ”¥ | ì˜¤ëŠ˜ ë†“ì¹˜ë©´ ì²˜ìŒë¶€í„°ì˜ˆìš”. |
| 30ì¼+ | {ë‹‰ë„¤ì„}ë‹˜, ğŸ† {n}ì¼ ëŒ€ê¸°ë¡ì„ ì§€ì¼œì£¼ì„¸ìš”! | í•œ ë‹¬ ë„˜ê²Œ ì´ì–´ì˜¨ ìŠ¤íŠ¸ë¦­ì´ì—ìš”. |

---

### 2.3 ë³µê·€ ìœ ë„ ì•Œë¦¼ (`comeback_*`) âœ… êµ¬í˜„ì™„ë£Œ

| í•­ëª© | ë‚´ìš© |
|-----|------|
| **ë°œì†¡ ë°©ì‹** | ì„œë²„ í‘¸ì‹œ (Expo Push API) |
| **íŠ¸ë¦¬ê±°** | pg_cron â†’ Edge Function |
| **ë°œì†¡ ì‹œì ** | ë§¤ì¼ 19:00 KST |
| **ë°œì†¡ ì œí•œ** | ê° ë‹¨ê³„ë³„ 1íšŒë§Œ ë°œì†¡, 14ì¼ ì´í›„ ë°œì†¡ ì¤‘ë‹¨ |
| **ì¹´ìš´íŠ¸ ë¦¬ì…‹** | ë³µê·€ í›„ ë‹¤ì‹œ ì¹´ìš´íŠ¸ ì‹œì‘ |

#### ë©”ì‹œì§€

| ì•Œë¦¼ ID | ì¡°ê±´ | ì œëª© | ë³¸ë¬¸ |
|---------|------|------|------|
| `comeback_3d` | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 3ì¼ | {ë‹‰ë„¤ì„}ë‹˜, ë‹¤ì‹œ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸ’ª | ì˜¤ëŠ˜ 1ê°œë§Œ ì‹¤ì²œí•´ë³´ì„¸ìš”. |
| `comeback_7d` | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 7ì¼ | {ë‹‰ë„¤ì„}ë‹˜, ëª©í‘œê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš” ğŸ¯ | ì–¸ì œë“  ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆì–´ìš”. |
| `comeback_14d` | ë§ˆì§€ë§‰ ì‹¤ì²œ í›„ 14ì¼ | {ë‹‰ë„¤ì„}ë‹˜, ìƒˆë¡œìš´ ëª©í‘œë¥¼ ì„¸ì›Œë³¼ê¹Œìš”? âœ¨ | ë§Œë‹¤ë¼íŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ìƒˆ ëª©í‘œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”. |

---

## ê¸°ìˆ  êµ¬í˜„ ìƒì„¸

### Push Token ì €ì¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ push_tokens í…Œì´ë¸”                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          : UUID (PK)                                     â”‚
â”‚ user_id     : UUID (FK â†’ auth.users)                        â”‚
â”‚ token       : TEXT (Expo Push Token)                        â”‚
â”‚ platform    : TEXT ('ios' | 'android' | 'web')              â”‚
â”‚ device_name : TEXT (ê¸°ê¸°ëª…)                                 â”‚
â”‚ is_active   : BOOLEAN (í™œì„±í™” ì—¬ë¶€)                          â”‚
â”‚ created_at  : TIMESTAMPTZ                                   â”‚
â”‚ updated_at  : TIMESTAMPTZ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì•Œë¦¼ ì„¤ì • ì €ì¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ notification_settings í…Œì´ë¸”                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                     : UUID (PK)                          â”‚
â”‚ user_id                : UUID (FK â†’ auth.users, UNIQUE)     â”‚
â”‚ reminder_enabled       : BOOLEAN (ì‹¤ì²œ ì•Œë¦¼ ON/OFF)          â”‚
â”‚ reminder_hour          : INTEGER (0-23, ê¸°ë³¸ 20)             â”‚
â”‚ reminder_minute        : INTEGER (0-59, ê¸°ë³¸ 0)              â”‚
â”‚ custom_message_enabled : BOOLEAN (ë§ì¶¤ ë©”ì‹œì§€ ON/OFF)        â”‚
â”‚ created_at             : TIMESTAMPTZ                        â”‚
â”‚ updated_at             : TIMESTAMPTZ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë°œì†¡ ì•„í‚¤í…ì²˜ (í†µí•© ì„œë²„ í‘¸ì‹œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì„œë²„ í‘¸ì‹œ (ëª¨ë“  ì•Œë¦¼ - ì‹¤ì²œ ì•Œë¦¼ + ë§ì¶¤ ë©”ì‹œì§€)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  pg_cron â”€â”€â†’ SQL Function â”€â”€â†’ send_expo_push â”€â”€â†’ Expo API  â”‚
â”‚    â”‚              â”‚                â”‚               â”‚        â”‚
â”‚  ìŠ¤ì¼€ì¤„        ëŒ€ìƒ ìœ ì € ì¡°íšŒ     ë©”ì‹œì§€ ìƒì„±     í‘¸ì‹œ ë°œì†¡  â”‚
â”‚  (ë§¤ ì‹œê°„)    + ê°œì¸í™” ë°ì´í„°    + íˆìŠ¤í† ë¦¬ ê¸°ë¡            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ëª¨ë°”ì¼ ì•±ì—ì„œëŠ” ì•Œë¦¼ ì„¤ì •ë§Œ DBì— ì €ì¥ (ë¡œì»¬ ì•Œë¦¼ ì—†ìŒ)
```

### Cron ìŠ¤ì¼€ì¤„

| Job ì´ë¦„ | Cron í‘œí˜„ì‹ | UTC ì‹œê°„ | KST ì‹œê°„ | ì„¤ëª… |
|---------|------------|----------|----------|------|
| `weekly-report-generation` | `0 3 * * 1` | ì›” 03:00 | ì›” 12:00 | ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± + ë°œì†¡ |
| `streak-warning` | `0 12 * * *` | ë§¤ì¼ 12:00 | ë§¤ì¼ 21:00 | ìŠ¤íŠ¸ë¦­ ìœ„í—˜ ì•Œë¦¼ |
| `comeback-notification` | `0 10 * * *` | ë§¤ì¼ 10:00 | ë§¤ì¼ 19:00 | ë³µê·€ ìœ ë„ ì•Œë¦¼ |
| `daily-reminder-18` | `0 9 * * *` | ë§¤ì¼ 09:00 | ë§¤ì¼ 18:00 | ì‹¤ì²œ ì•Œë¦¼ (KST 18ì‹œ) |
| `daily-reminder-19` | `0 10 * * *` | ë§¤ì¼ 10:00 | ë§¤ì¼ 19:00 | ì‹¤ì²œ ì•Œë¦¼ (KST 19ì‹œ) |
| `daily-reminder-20` | `0 11 * * *` | ë§¤ì¼ 11:00 | ë§¤ì¼ 20:00 | ì‹¤ì²œ ì•Œë¦¼ (KST 20ì‹œ, ê¸°ë³¸) |
| `daily-reminder-21` | `0 12 * * *` | ë§¤ì¼ 12:00 | ë§¤ì¼ 21:00 | ì‹¤ì²œ ì•Œë¦¼ (KST 21ì‹œ) |
| `daily-reminder-22` | `0 13 * * *` | ë§¤ì¼ 13:00 | ë§¤ì¼ 22:00 | ì‹¤ì²œ ì•Œë¦¼ (KST 22ì‹œ) |
| `daily-reminder-hourly` | `0 * * * *` | ë§¤ ì‹œê°„ | ë§¤ ì‹œê°„ | ê¸°íƒ€ ì‹œê°„ ì‹¤ì²œ ì•Œë¦¼ (18-22ì‹œ ì œì™¸) |

---

## ì•Œë¦¼ ì„¤ì • UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì•Œë¦¼ ì„¤ì •                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ â° ì‹¤ì²œ ì•Œë¦¼                       [ON]                     â”‚
â”‚    ì„¤ì •í•œ ì‹œê°„ì— ì˜¤ëŠ˜ì˜ ì‹¤ì²œ ë¦¬ë§ˆì¸ë”                         â”‚
â”‚    > ì•Œë¦¼ ì‹œê°„: ì˜¤í›„ 8:00                                   â”‚
â”‚                                                             â”‚
â”‚ ğŸ“¬ ë§ì¶¤ ë©”ì‹œì§€                     [ON]                     â”‚
â”‚    ì£¼ê°„ ë¦¬í¬íŠ¸, ìŠ¤íŠ¸ë¦­ ìœ„í—˜, ë³µê·€ ì•ˆë‚´ ë“±                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì™„ë£Œ

- [x] push_tokens í…Œì´ë¸” ìƒì„±
- [x] RLS ì •ì±… ì„¤ì •
- [x] weekly_report pg_cron ìŠ¤ì¼€ì¤„ ë“±ë¡ (ì›”ìš”ì¼ 12:00 KST)
- [x] scheduled-report Edge Function ë°°í¬
- [x] send-push-notification Edge Function ë°°í¬
- [x] ëª¨ë°”ì¼ ì•± push token DB ì €ì¥ ê¸°ëŠ¥
- [x] notification_history í…Œì´ë¸” ìƒì„± (ì¤‘ë³µ ë°©ì§€ìš©)
- [x] streak_warning SQL í•¨ìˆ˜ êµ¬í˜„ + pg_cron ìŠ¤ì¼€ì¤„ ë“±ë¡ (ë§¤ì¼ 21:00 KST)
- [x] comeback ì•Œë¦¼ SQL í•¨ìˆ˜ êµ¬í˜„ + pg_cron ìŠ¤ì¼€ì¤„ ë“±ë¡ (ë§¤ì¼ 19:00 KST)
- [x] streak-warning Edge Function ë°°í¬ (ë°±ì—…ìš©)
- [x] comeback-notification Edge Function ë°°í¬ (ë°±ì—…ìš©)
- [x] weekly_report ë‹‰ë„¤ì„ ê°œì¸í™” ì ìš©
- [x] notification_settings í…Œì´ë¸” ìƒì„± (ìœ ì €ë³„ ì•Œë¦¼ ì‹œê°„ ì„¤ì •)
- [x] daily_reminder ì„œë²„ í‘¸ì‹œ ì „í™˜ (ë¡œì»¬ ì•Œë¦¼ â†’ pg_cron + Expo API)
- [x] daily_reminder ê°œì¸í™” ë©”ì‹œì§€ êµ¬í˜„ (ìŠ¤íŠ¸ë¦­, ì™„ë£Œ ìƒíƒœ ê¸°ë°˜)
- [x] ëª¨ë°”ì¼ ì•± useNotifications hook DB ì €ì¥ ë°©ì‹ ì „í™˜

### ê°œë°œ ì˜ˆì •

(ëª¨ë“  í•­ëª© ì™„ë£Œ)

---

## ë°°í¬ ëª…ë ¹ì–´

```bash
# 1. Migration ì ìš©
npx supabase db push

# 2. Edge Functions ë°°í¬ (ë°±ì—…ìš©, ì£¼ìš” ë¡œì§ì€ SQL í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬)
npx supabase functions deploy scheduled-report
npx supabase functions deploy send-push-notification
npx supabase functions deploy streak-warning
npx supabase functions deploy comeback-notification

# 3. ë³´ì•ˆ ì‹œí¬ë¦¿ ì„¤ì •
npx supabase secrets set CRON_SECRET=your-secret-key
```

## êµ¬í˜„ íŒŒì¼ ëª©ë¡

### Database Migrations
- `supabase/migrations/20251130000001_add_push_tokens_and_weekly_report_cron.sql`
- `supabase/migrations/20251130000002_update_weekly_report_cron_time.sql`
- `supabase/migrations/20251130000003_add_notification_history_and_streak_warning.sql`
- `supabase/migrations/20251130000004_add_notification_cron_schedules.sql`
- `supabase/migrations/20251130000005_notification_sql_functions.sql`
- `supabase/migrations/20251130000007_daily_reminder_server_push.sql` (ì‹ ê·œ)
  - `notification_settings` í…Œì´ë¸” ìƒì„±
  - `get_users_for_daily_reminder(p_hour)` í•¨ìˆ˜
  - `process_daily_reminder_notifications(p_hour)` í•¨ìˆ˜
  - pg_cron ìŠ¤ì¼€ì¤„ (ë§¤ ì‹œê°„)

### SQL Functions
- `get_users_for_streak_warning()`: ìŠ¤íŠ¸ë¦­ ìœ„í—˜ ì•Œë¦¼ ëŒ€ìƒ ì¡°íšŒ
- `get_users_for_comeback_notification(days)`: ë³µê·€ ì•Œë¦¼ ëŒ€ìƒ ì¡°íšŒ
- `get_users_for_daily_reminder(p_hour)`: í•´ë‹¹ ì‹œê°„ ì‹¤ì²œ ì•Œë¦¼ ëŒ€ìƒ ì¡°íšŒ (ì‹ ê·œ)
- `record_notification_sent(user_id, type, metadata)`: ì•Œë¦¼ ë°œì†¡ ì´ë ¥ ê¸°ë¡
- `send_expo_push_notification(token, title, body, data)`: Expo Push API í˜¸ì¶œ
- `process_streak_warning_notifications()`: ìŠ¤íŠ¸ë¦­ ì•Œë¦¼ ì¼ê´„ ì²˜ë¦¬
- `process_comeback_notifications()`: ë³µê·€ ì•Œë¦¼ ì¼ê´„ ì²˜ë¦¬
- `process_daily_reminder_notifications(p_hour)`: ì‹¤ì²œ ì•Œë¦¼ ì¼ê´„ ì²˜ë¦¬ (ì‹ ê·œ)

### Edge Functions (ë°±ì—…ìš©)
- `supabase/functions/streak-warning/index.ts`
- `supabase/functions/comeback-notification/index.ts`

### Mobile App (ì•Œë¦¼ ì„¤ì •)
- `apps/mobile/src/hooks/useNotifications.ts`
  - `notification_settings` í…Œì´ë¸” ì—°ë™
  - `toggleNotifications()`: í‘¸ì‹œ ì•Œë¦¼ ê¶Œí•œ On/Off
  - `toggleReminder()`: ì‹¤ì²œ ì•Œë¦¼ On/Off (DB ì €ì¥)
  - `toggleCustomMessage()`: ë§ì¶¤ ë©”ì‹œì§€ On/Off (DB ì €ì¥)
  - `updateReminderTime()`: ì•Œë¦¼ ì‹œê°„ ë³€ê²½ (DB ì €ì¥)
- `apps/mobile/src/services/notificationService.ts`
  - `registerForPushNotificationsAsync()`: í‘¸ì‹œ í† í° ë“±ë¡
  - `areNotificationsEnabled()`: ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€ í™•ì¸
  - `setNotificationsEnabled()`: ì•Œë¦¼ í™œì„±í™” ì„¤ì •

---

## ê´€ë ¨ ë¬¸ì„œ

- [ë¦¬í¬íŠ¸ ìƒì„± ì •ì±…](./REPORT_GENERATION_POLICY.md)
- [ì•Œë¦¼ ì‹œìŠ¤í…œ ì§„í–‰ìƒí™©](./NOTIFICATION_SYSTEM_PROGRESS.md)
- [XP ì‹œìŠ¤í…œ](./XP_SYSTEM_PHASE2_COMPLETE.md)
- [ë±ƒì§€ ì‹œìŠ¤í…œ](./BADGE_SYSTEM_V5_RENEWAL.md)

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ ë‚´ìš© |
|-----|------|----------|
| 2025-11-30 | v1.0 | ìµœì´ˆ ë¬¸ì„œ ì‘ì„±, ì£¼ê°„ ë¦¬í¬íŠ¸/ì¼ì¼ ë¦¬ë§ˆì¸ë” ì •ì±… ì •ì˜ |
| 2025-11-30 | v2.0 | ì¹´í…Œê³ ë¦¬ ì¬êµ¬ì„± (ì‹¤ì²œ ì•Œë¦¼/ë§ì¶¤ ë©”ì‹œì§€), ë‹‰ë„¤ì„ ê°œì¸í™” ì¶”ê°€, streak_warning/comeback ì•Œë¦¼ ì •ì±… í™•ì • |
| 2025-11-30 | v2.1 | streak_warning, comeback ì•Œë¦¼ êµ¬í˜„ ì™„ë£Œ (SQL í•¨ìˆ˜ + pg_cron ë°©ì‹) |
| 2025-11-30 | v2.2 | weekly_report ë‹‰ë„¤ì„ ê°œì¸í™”, daily_reminder ê°œì¸í™” ë©”ì‹œì§€ êµ¬í˜„ ì™„ë£Œ |
| 2025-11-30 | v2.3 | ì•Œë¦¼ ì„¤ì • UI ì™„ë£Œ, ì•Œë¦¼ ì»¨í…ìŠ¤íŠ¸ ìë™ ê°±ì‹  êµ¬í˜„ |
| 2025-11-30 | v3.0 | **daily_reminder ì„œë²„ í‘¸ì‹œ ì „í™˜**: ë¡œì»¬ ì•Œë¦¼ â†’ pg_cron + Expo Push API. notification_settings í…Œì´ë¸” ë„ì…. ëª¨ë“  ì•Œë¦¼ í†µí•© ì„œë²„ í‘¸ì‹œ ë°©ì‹ ì™„ë£Œ. |
