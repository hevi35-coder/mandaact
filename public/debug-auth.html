<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug</title>
</head>
<body>
    <h1>Supabase Auth Debugger</h1>
    <button onclick="checkAuth()">Check Auth Status</button>
    <pre id="output"></pre>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.38.0'

        const supabase = createClient(
            'https://gxnvovnwlqjstpcsprqr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4bnZvdm53bHFqc3RwY3NwcnFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3MDEzNTgsImV4cCI6MjA3NzI3NzM1OH0.OhPreVo70eIGok7D3L9lgvxJH0JfuqHCp9vPro1uXQU'
        )

        window.checkAuth = async function() {
            const output = document.getElementById('output')

            try {
                // Get current session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession()

                const result = {
                    timestamp: new Date().toISOString(),
                    hasSession: !!session,
                    sessionError: sessionError?.message,
                    user: session?.user ? {
                        id: session.user.id,
                        email: session.user.email
                    } : null,
                    accessToken: session?.access_token ? session.access_token.substring(0, 50) + '...' : 'NONE',
                    tokenExpiry: session?.expires_at ? new Date(session.expires_at * 1000).toLocaleString() : 'N/A'
                }

                output.textContent = JSON.stringify(result, null, 2)

                // Test API call
                if (session) {
                    output.textContent += '\n\n=== Testing API Call ===\n'

                    const response = await fetch('https://gxnvovnwlqjstpcsprqr.supabase.co/functions/v1/chat', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${session.access_token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ message: 'test' })
                    })

                    output.textContent += `Status: ${response.status}\n`
                    const responseData = await response.json()
                    output.textContent += JSON.stringify(responseData, null, 2)
                }
            } catch (error) {
                output.textContent = `Error: ${error.message}\n${error.stack}`
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(() => window.checkAuth(), 500)
        })
    </script>
</body>
</html>
